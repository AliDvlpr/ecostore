{% extends "front/base.html" %}
{% load static %}

{% block title %}
search
{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row">
    <!-- Left: Images slider with thumbnails -->
    <div class="col-lg-6 mb-4">
      <div class="position-sticky" style="top: 100px;">
        <!-- Main image -->
        <div class="overflow-hidden mb-2">
          <img
            id="main-image"
            src="{{ product.images.0 }}"
            class="img-fluid w-100"
            style="max-height: 500px; object-fit: contain;"
          />
        </div>

        <!-- Thumbnails -->
        <div class="d-flex flex-wrap gap-2">
          {% for img in product.images %}
          <img
            src="{{ img }}"
            class="img-thumbnail thumbnail-img"
            style="width: 80px; height: 80px; object-fit: contain; cursor: pointer;"
          />
          {% endfor %}
        </div>

        <!-- Buy Button -->
        {% if not product.pricing and not product.list_price %}
        <button class="btn btn-secondary w-100 mt-3">Unavailable</button>
        {% else %}
        <button class="btn btn-success w-100 mt-3">Buy Now</button>
        {% endif %}
      </div>
    </div>

    <!-- Right: Product info -->
    <div class="col-lg-6">
      <!-- Name -->
      <h1 class="h3">{{ product.name }}</h1>

      <!-- Price -->
      <div class="mb-2">
        <span class="h4 text-danger">{{ product.pricing }}</span>
        {% if product.list_price %}
        <span class="text-muted text-decoration-line-through">{{ product.list_price }}</span>
        {% endif %}
      </div>

      <!-- Availability -->
      <div class="mb-3 text-success fw-bold">{{ product.availability }}</div>

      <!-- Description -->
      <div class="mb-3">{{ product.description|safe }}</div>

      <!-- Feature bullets -->
      <ul class="mb-3">
        {% for bullet in product.feature_bullets %}
        <li>{{ bullet }}</li>
        {% endfor %}
      </ul>

      <!-- Customization options -->
      {% for field, choices in product.customization_options.items %}
      <div class="mb-4">
        <h3 class="font-semibold">{{ field|capfirst }}</h3>
        <div class="d-flex flex-wrap gap-2 mt-2">
          {% for choice in choices %}
            {% if choice.image %}
            <!-- Choice with image -->
            <a href="{% url 'search_page' %}?asin={{ choice.asin }}" class="btn btn-outline-light d-flex flex-column align-items-center p-1">
              <img src="{{ choice.image }}" class="img-fluid" style="width:50px; height:50px; object-fit:contain;">
              <small>{{ choice.value }}</small>
            </a>
            {% else %}
            <!-- Choice without image -->
            <a href="{% url 'search_page' %}?asin={{ choice.asin }}" class="btn btn-light">
              {{ choice.value }} ({{ choice.asin }})
            </a>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

{{ product|json_script:"product-data" }}
<script>
  const productData = JSON.parse(document.getElementById("product-data").textContent);
  console.log("Full product API data:", productData);

  // Main image change via thumbnails
  const mainImage = document.getElementById("main-image");
  const thumbnails = document.querySelectorAll(".thumbnail-img");

  thumbnails.forEach((thumb) => {
    thumb.addEventListener("click", () => {
      mainImage.src = thumb.src;

      // Highlight active thumbnail
      thumbnails.forEach(t => t.classList.remove("border-primary", "border-2"));
      thumb.classList.add("border-primary", "border-2");
    });
  });

  // Set first thumbnail active initially
  if (thumbnails.length > 0) thumbnails[0].classList.add("border-primary", "border-2");
</script>
{% endblock %}
