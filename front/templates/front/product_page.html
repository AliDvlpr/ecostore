{% extends "front/base.html" %}
{% load static %}

{% block title %}Product{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row">
    <!-- LEFT: Image Slider -->
    <div class="col-lg-6 mb-4">
      <div class="position-sticky" style="top: 100px;">
        <!-- Main Image -->
        <div class="overflow-hidden mb-2">
          <img id="main-image" src="{{ details.images.0 }}" class="img-fluid w-100" style="max-height: 500px; object-fit: contain;">
        </div>

        <!-- Thumbnails -->
        <div class="d-flex flex-wrap gap-2">
          {% for img in details.images %}
            <img src="{{ img }}" class="img-thumbnail thumbnail-img" style="width: 80px; height: 80px; object-fit: contain; cursor: pointer;">
          {% endfor %}
        </div>

        <!-- Buy Button -->
        {% if store_products %}
          <!-- If at least one store has the product -->
          <button class="btn btn-success w-100 mt-3" data-bs-toggle="modal" data-bs-target="#storesModal">
            Buy Now
          </button>
        {% else %}
          <!-- Fall back to pricing info -->
          {% if details.pricing|default:0 > 0 or details.list_price|default:0 > 0 %}
            <button class="btn btn-success w-100 mt-3">Buy Now</button>
          {% else %}
            <button class="btn btn-secondary w-100 mt-3" disabled>Unavailable</button>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <!-- RIGHT: Product Info -->
    <div class="col-lg-6">
      <h1 class="h3">{{ product.title }}</h1>

      <!-- Price -->
      <div class="mb-2">
        {% if details.pricing|default:0 > 0 %}
          <span class="h4 text-danger">${{ details.pricing }}</span>
          {% if details.list_price|default:0 > 0 %}
            <span class="text-muted text-decoration-line-through">${{ details.list_price }}</span>
          {% endif %}
        {% elif details.list_price|default:0 > 0 %}
          <span class="h4 text-danger">${{ details.list_price }}</span>
        {% else %}
          <span class="text-danger">Unavailable</span>
        {% endif %}
      </div>

      <!-- Description -->
      {% if details.description %}
        <p class="mb-2">{{ details.description }}</p>
      {% endif %}

      <!-- Features -->
      {% if details.feature_bullets %}
        <ul>
          {% for bullet in details.feature_bullets %}
            <li>{{ bullet }}</li>
          {% endfor %}
        </ul>
      {% endif %}

      <!-- Customization options -->
      {% if details.customization_options %}
        {% for option, values in details.customization_options.items %}
          <div class="mb-4">
            <h3 class="font-semibold">{{ option }}</h3>
            <div class="d-flex flex-wrap gap-2 mt-2">
              {% for val in values %}
                {% if val.image %}
                  <a href="{% url 'search_page' %}?asin={{ val.asin }}" class="btn btn-outline-light d-flex flex-column align-items-center p-1">
                    <img src="{{ val.image }}" class="img-fluid" style="width: 50px; height: 50px; object-fit: contain;">
                    <small>{{ val.value }}</small>
                  </a>
                {% else %}
                  <a href="{% url 'search_page' %}?asin={{ val.asin }}" class="btn btn-light">
                    {{ val.value }} ({{ val.asin }})
                  </a>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Stores Modal -->
    <div class="modal fade" id="storesModal" tabindex="-1" aria-labelledby="storesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="storesModalLabel">Available Stores</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th>Store</th>
                  <th>Price</th>
                  <th>Stock</th>
                  <th>Quantity</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <!-- Amazon row -->
                <tr>
                  <td><strong>Amazon</strong></td>
                  <td>
                    {% if details.pricing|default:0 > 0 %}
                      ${{ details.pricing }}
                    {% elif details.list_price|default:0 > 0 %}
                      ${{ details.list_price }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td><span class="badge bg-success">In stock</span></td>
                  <td>
                    <input type="number" class="form-control form-control-sm quantity-input" value="1" min="1" style="width:70px;">
                  </td>
                  <td>
                    <a href="{% url 'add_to_cart' %}?product_id={{ product.id }}&quantity=1"
                      class="btn btn-sm btn-primary add-to-cart-btn">Buy</a>
                  </td>
                </tr>

                <!-- Store products -->
                {% if store_products %}
                  {% for sp in store_products %}
                    <tr>
                      <td>
                        <strong>{{ sp.store.name }}</strong><br>
                        {% if sp.store.address %}<small>{{ sp.store.address }}</small><br>{% endif %}
                        {% if sp.store.phone %}<small>ðŸ“ž {{ sp.store.phone }}</small>{% endif %}
                      </td>
                      <td>${{ sp.price }}</td>
                      <td>
                        {% if sp.stock %}
                          <span class="badge bg-success">In stock</span>
                        {% else %}
                          <span class="badge bg-danger">Out of stock</span>
                        {% endif %}
                      </td>
                      <td>
                        <input type="number" class="form-control form-control-sm quantity-input" value="1" min="1" style="width:70px;" {% if not sp.stock %}disabled{% endif %}>
                      </td>
                      <td>
                        {% if sp.stock %}
                          <a href="{% url 'add_to_cart' %}?store_product_id={{ sp.id }}&quantity=1"
                            class="btn btn-sm btn-primary add-to-cart-btn">Buy</a>
                        {% else %}
                          <button class="btn btn-sm btn-secondary" disabled>Unavailable</button>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="5" class="text-muted">This product is not yet available in any store.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
document.querySelectorAll('.add-to-cart-btn').forEach((btn) => {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    const row = btn.closest('tr');
    const quantity = row.querySelector('.quantity-input').value || 1;
    let url = btn.getAttribute('href');
    url += '&quantity=' + quantity;
    window.location.href = url;
  });
});
</script>



  </div>
</div>

<script>
  // Thumbnail switching
  const mainImage = document.getElementById("main-image");
  const thumbnails = document.querySelectorAll(".thumbnail-img");

  thumbnails.forEach((thumb) => {
    thumb.addEventListener("click", () => {
      mainImage.src = thumb.src;
      thumbnails.forEach(t => t.classList.remove("border-primary", "border-2"));
      thumb.classList.add("border-primary", "border-2");
    });
  });

  if (thumbnails.length > 0) thumbnails[0].classList.add("border-primary", "border-2");
</script>
{% endblock %}
